
import lambdaTTS
import lambdaSpeechToScore
import lambdaGetSample
import base64
import io
import base64
import io
from flask import Flask
from flask import request
from flask import Response
import json
import base64
import subprocess

application = Flask(__name__) 


@application.route('/model/spelling', methods=['POST'])
def execute_spelling():
    try :
      language = 'en'
      encode_string = request.get_json().get("voice")
      title = request.get_json().get("title")

      wav_file = open("hearing.wav", "wb")
      decode_string = base64.b64decode(encode_string)
      wav_file.write(decode_string)

      command = "python ~/milo/denoiser/denoiser.py ~/milo/Spelling_trainer/hearing.wav ~/milo/Spelling_trainer/hearing_output.wav"

      result = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    
      sentence_to_read = lambdaGetSample.lambda_handler(language)
      #print("Sentence to read : ", sentence_to_read['real_transcript'][0])
      #print("Phonetics : ", sentence_to_read['ipa_transcript'])
      #title = 'That isnt how most people do that.'
      #print("Sentence to read : ", sentence_to_read['real_transcript'][0])

      lambdaTTS.lambda_handler(title)


      speech_to_score = lambdaSpeechToScore.lambda_handler(title, language)
      words_result_html = "<div>"
      for char_result in list(zip(speech_to_score["real_transcripts"], speech_to_score["is_letter_correct_all_words"])):
          if char_result[1] == '1':
       	 	words_result_html += "<span style= '" + "color:green" + " ' >" + char_result[0] + "</span>"
          else:
                words_result_html += "<span style= ' " + "color:red" + " ' >" + char_result[0] + "</span>"

      words_result_html += "</div>"
      speech_to_score["voice_result_html"] = words_result_html

      #print("Final result:", speech_to_score)
 
      return Response(json.dumps({'result': speech_to_score }),
                      status=200,
                      mimetype="application/json")
      #return "Hello from milo"
    except : 
      words_result_html = "<span style= '" + "color:red" + " ' > Error ! Please try again. </span>"
      
	
if __name__ == '__main__':
    application.run(host='0.0.0.0', port=3000,debug=False)








